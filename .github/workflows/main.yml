name: YouTube Copyright Removal Automation

on:
  # Execu√ß√£o manual via interface do GitHub
  workflow_dispatch:
  
  # Execu√ß√£o agendada (opcional - ajuste conforme necess√°rio)
  # schedule:
  #   - cron: '0 2 * * *'  # Diariamente √†s 2:00 AM UTC

jobs:
  run-youtube-automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb wget
          
          # Instala Google Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || true
          sudo apt-get -f install -y -qq
          rm -f google-chrome-stable_current_amd64.deb
          
          # Instala ChromeDriver
          sudo apt-get install -y -qq chromium-chromedriver
          
          # Verifica instala√ß√µes
          google-chrome --version
          chromedriver --version
      
      - name: üìö Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium xvfbwrapper
      
      - name: üöÄ Run YouTube automation script
        id: run_script
        continue-on-error: true
        run: |
          echo "üé¨ Iniciando automa√ß√£o..."
          python yt.py
          echo "script_status=$?" >> $GITHUB_OUTPUT
        timeout-minutes: 60
      
      - name: üì∏ Upload screenshots as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: youtube-automation-screenshots-${{ github.run_number }}
          path: screenshots_*/
          retention-days: 30
          if-no-files-found: warn
      
      - name: üìä Generate execution summary
        if: always()
        run: |
          echo "## üé¨ YouTube Automation Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d screenshots_* ]; then
            SCREENSHOT_COUNT=$(find screenshots_*/ -name "*.png" 2>/dev/null | wc -l)
            echo "**Screenshots Captured:** $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $SCREENSHOT_COUNT -gt 0 ]; then
              echo "### üì∏ Screenshots Location" >> $GITHUB_STEP_SUMMARY
              echo "Check the artifacts section to download all screenshots." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Screenshots:** No screenshots folder found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.run_script.outputs.script_status }}" == "0" ]; then
            echo "**Status:** ‚úÖ Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ö†Ô∏è Completed with warnings or errors" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üßπ Cleanup
        if: always()
        run: |
          # Remove arquivos tempor√°rios do Chrome
          rm -rf /tmp/ChromeSeleniumProfile 2>/dev/null || true
          
          # Remove arquivos tempor√°rios
          rm -f google-chrome-stable_current_amd64.deb 2>/dev/null || true
      
      - name: ‚úÖ Workflow completed
        if: success()
        run: echo "‚úÖ Automa√ß√£o conclu√≠da com sucesso!"
      
      - name: ‚ö†Ô∏è Workflow finished with issues
        if: failure()
        run: |
          echo "‚ö†Ô∏è A automa√ß√£o foi conclu√≠da mas encontrou alguns problemas."
          echo "Verifique os logs acima e os screenshots nos artifacts para mais detalhes."
